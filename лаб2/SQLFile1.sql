-- Создание базы данных
CREATE DATABASE TradeRentalManagement;
GO

USE TradeRentalManagement;
GO

-- Создание таблицы Скидка
CREATE TABLE Discount (
    ID_Скидки INT PRIMARY KEY IDENTITY(1,1),
    Название NVARCHAR(255) NOT NULL,
    Размер DECIMAL(10,2) NOT NULL CHECK (Размер >= 0 AND Размер <= 100)
);

-- Создание таблицы Торговая точка
CREATE TABLE RetailPoint (
    ID INT PRIMARY KEY IDENTITY(1,1),
    Адрес NVARCHAR(255) NOT NULL,
    Этаж INT NOT NULL,
    Площадь DECIMAL(10,2) NOT NULL CHECK (Площадь > 0),
    Наличие_Кондиционера BIT NOT NULL DEFAULT 0,
    Стоимость_Аренды DECIMAL(12,2) NOT NULL CHECK (Стоимость_Аренды > 0),
    Статус BIT NOT NULL DEFAULT 1 -- 1 - свободна, 0 - занята
);

-- Создание таблицы Клиент
CREATE TABLE Client (
    ID INT PRIMARY KEY IDENTITY(1,1),
    Название NVARCHAR(255) NOT NULL,
    Юридический_Адрес NVARCHAR(255) NOT NULL,
    Банковские_Реквизиты TEXT NOT NULL,
    Телефон NVARCHAR(50),
    ФИО_Контактного_Лица NVARCHAR(255) NOT NULL
);

-- Создание таблицы Договор
CREATE TABLE Contract (
    ID INT PRIMARY KEY IDENTITY(1,1),
    Номер_Договора NVARCHAR(100) NOT NULL UNIQUE,
    Дата_Заключения DATE NOT NULL DEFAULT GETDATE(),
    Дата_Окончания DATE NOT NULL,
    Финальная_Стоимость DECIMAL(12,2) NOT NULL CHECK (Финальная_Стоимость > 0),
    ID_Клиента INT NOT NULL,
    ID_Точки INT NOT NULL,
    ID_Скидки INT,
    CHECK (Дата_Окончания > Дата_Заключения)
);

-- Создание таблицы Платеж
CREATE TABLE Payment (
    ID INT PRIMARY KEY IDENTITY(1,1),
    ID_Договора INT NOT NULL,
    Месяц INT NOT NULL CHECK (Месяц >= 1 AND Месяц <= 12),
    Сумма DECIMAL(12,2) NOT NULL CHECK (Сумма > 0),
    Дата_Оплаты DATE NULL,
    Статус BIT NOT NULL DEFAULT 0 -- 0 - не оплачен, 1 - оплачен
);

-- Создание связей между таблицами (внешние ключи)
ALTER TABLE Contract ADD CONSTRAINT FK_Contract_Client 
    FOREIGN KEY (ID_Клиента) REFERENCES Client(ID) ON DELETE CASCADE;

ALTER TABLE Contract ADD CONSTRAINT FK_Contract_RetailPoint 
    FOREIGN KEY (ID_Точки) REFERENCES RetailPoint(ID) ON DELETE CASCADE;

ALTER TABLE Contract ADD CONSTRAINT FK_Contract_Discount 
    FOREIGN KEY (ID_Скидки) REFERENCES Discount(ID_Скидки) ON DELETE SET NULL;

ALTER TABLE Payment ADD CONSTRAINT FK_Payment_Contract 
    FOREIGN KEY (ID_Договора) REFERENCES Contract(ID) ON DELETE CASCADE;

-- Заполнение таблицы Скидка
INSERT INTO Discount (Название, Размер) VALUES 
('Стандартная', 0.00),
('Для новых клиентов', 5.00),
('Долгосрочная аренда', 10.00),
('Сезонная скидка', 7.00),
('Оптовая', 12.00),
('Социальная', 15.00),
('Партнерская', 8.00),
('Акционная', 20.00),
('Постоянным клиентам', 6.00),
('Предпринимателям', 3.00);

-- Заполнение таблицы Торговая точка
INSERT INTO RetailPoint (Адрес, Этаж, Площадь, Наличие_Кондиционера, Стоимость_Аренды, Статус) VALUES 
('ул. Ленина, д. 15, ТЦ "Центральный"', 1, 45.50, 1, 25000.00, 0),
('пр. Мира, д. 28, ТЦ "Европа"', 2, 30.25, 1, 18000.00, 1),
('ул. Советская, д. 5, ТЦ "Атриум"', 1, 60.00, 1, 35000.00, 0),
('ул. Кирова, д. 12, ТЦ "Нева"', 3, 25.75, 0, 12000.00, 1),
('пр. Победы, д. 45, ТЦ "Виктория"', 1, 80.20, 1, 45000.00, 0),
('ул. Гагарина, д. 8, ТЦ "Орбита"', 2, 35.40, 1, 20000.00, 1),
('ул. Пушкина, д. 33, ТЦ "Литера"', 1, 55.80, 1, 32000.00, 0),
('ул. Садовая, д. 20, ТЦ "Флора"', 2, 40.30, 0, 22000.00, 1),
('пр. Космонавтов, д. 17, ТЦ "Галактика"', 1, 70.15, 1, 38000.00, 0),
('ул. Лесная, д. 3, ТЦ "Тайга"', 3, 28.90, 1, 15000.00, 1);

-- Заполнение таблицы Клиент
INSERT INTO Client (Название, Юридический_Адрес, Банковские_Реквизиты, Телефон, ФИО_Контактного_Лица) VALUES 
('ООО "Вкусные продукты"', 'г. Москва, ул. Промышленная, д. 15', 'р/с 40702810500000012345 в ПАО "Сбербанк", БИК 044525225', '+7(495)123-45-67', 'Иванов Петр Сергеевич'),
('ИП Сидоров А.В.', 'г. Москва, пр. Ленинградский, д. 78, кв. 45', 'р/с 40802810700000023456 в АО "Альфа-Банк", БИК 044525593', '+7(916)234-56-78', 'Сидоров Алексей Владимирович'),
('ООО "Модный стиль"', 'г. Москва, ул. Тверская, д. 25', 'р/с 40702810800000034567 в ПАО "ВТБ", БИК 044525187', '+7(495)234-56-78', 'Петрова Марина Игоревна'),
('АО "ТехноМир"', 'г. Москва, ул. Профсоюзная, д. 89', 'р/с 40702810900000045678 в ПАО "Газпромбанк", БИК 044525201', '+7(495)345-67-89', 'Кузнецов Дмитрий Олегович'),
('ООО "Книжный мир"', 'г. Москва, ул. Арбат, д. 34', 'р/с 40702811000000056789 в ПАО "Сбербанк", БИК 044525225', '+7(495)456-78-90', 'Смирнова Ольга Васильевна'),
('ИП Козлова Е.Н.', 'г. Москва, ул. Новый Арбат, д. 56', 'р/с 40802811100000067890 в АО "Тинькофф Банк", БИК 044525974', '+7(916)345-67-89', 'Козлова Елена Николаевна'),
('ООО "СпортМастер"', 'г. Москва, ул. Лужнецкая, д. 12', 'р/с 40702811200000078901 в ПАО "ВТБ", БИК 044525187', '+7(495)567-89-01', 'Волков Сергей Петрович'),
('АО "Косметика Профи"', 'г. Москва, ул. Садовая-Кудринская, д. 7', 'р/с 40702811300000089012 в ПАО "Сбербанк", БИК 044525225', '+7(495)678-90-12', 'Николаева Анна Константиновна'),
('ООО "Детский рай"', 'г. Москва, пр. Вернадского, д. 92', 'р/с 40702811400000090123 в ПАО "Альфа-Банк", БИК 044525593', '+7(495)789-01-23', 'Федорова Ирина Викторовна'),
('ИП Морозов П.К.', 'г. Москва, ул. Пречистенка, д. 18', 'р/с 40802811500000001234 в ПАO "Сбербанк", БИК 044525225', '+7(916)456-78-90', 'Морозов Павел Константинович');

-- Заполнение таблицы Договор
INSERT INTO Contract (Номер_Договора, Дата_Заключения, Дата_Окончания, Финальная_Стоимость, ID_Клиента, ID_Точки, ID_Скидки) VALUES 
('ДГ-2024-001', '2024-01-15', '2024-12-31', 25000.00, 1, 1, 1),
('ДГ-2024-002', '2024-02-01', '2024-11-30', 17100.00, 2, 2, 2),
('ДГ-2024-003', '2024-01-20', '2024-12-31', 31500.00, 3, 3, 3),
('ДГ-2024-004', '2024-03-10', '2024-09-30', 11160.00, 4, 4, 4),
('ДГ-2024-005', '2024-02-15', '2024-12-31', 45000.00, 5, 5, 1),
('ДГ-2024-006', '2024-03-01', '2024-08-31', 17600.00, 6, 6, 7),
('ДГ-2024-007', '2024-01-25', '2024-12-31', 32000.00, 7, 7, 1),
('ДГ-2024-008', '2024-02-20', '2024-10-31', 20240.00, 8, 8, 9),
('ДГ-2024-009', '2024-03-05', '2024-12-31', 38000.00, 9, 9, 1),
('ДГ-2024-010', '2024-02-28', '2024-07-31', 14550.00, 10, 10, 10);

-- Заполнение таблицы Платеж (демонстрация связи 1:M - один договор имеет много платежей)
INSERT INTO Payment (ID_Договора, Месяц, Сумма, Дата_Оплаты, Статус) VALUES 
-- Платежи по договору 1
(1, 1, 25000.00, '2024-01-15', 1),
(1, 2, 25000.00, '2024-02-15', 1),
(1, 3, 25000.00, '2024-03-15', 1),
(1, 4, 25000.00, '2024-04-15', 1),
(1, 5, 25000.00, '2024-05-15', 1),
(1, 6, 25000.00, '2024-06-15', 1),
(1, 7, 25000.00, '2024-07-15', 1),
(1, 8, 25000.00, NULL, 0), -- Не оплачен
(1, 9, 25000.00, NULL, 0), -- Не оплачен

-- Платежи по договору 2
(2, 1, 17100.00, '2024-02-01', 1),
(2, 2, 17100.00, '2024-03-01', 1),
(2, 3, 17100.00, '2024-04-01', 1),
(2, 4, 17100.00, '2024-05-01', 1),
(2, 5, 17100.00, '2024-06-01', 1),
(2, 6, 17100.00, NULL, 0), -- Не оплачен

-- Платежи по договору 3
(3, 1, 31500.00, '2024-01-20', 1),
(3, 2, 31500.00, '2024-02-20', 1),
(3, 3, 31500.00, '2024-03-20', 1),
(3, 4, 31500.00, '2024-04-20', 1),
(3, 5, 31500.00, '2024-05-20', 1),
(3, 6, 31500.00, '2024-06-20', 1),
(3, 7, 31500.00, NULL, 0), -- Не оплачен

-- Платежи по договору 4
(4, 1, 11160.00, '2024-03-10', 1),
(4, 2, 11160.00, '2024-04-10', 1),
(4, 3, 11160.00, '2024-05-10', 1),
(4, 4, 11160.00, '2024-06-10', 1),
(4, 5, 11160.00, NULL, 0), -- Не оплачен

-- Платежи по договору 5
(5, 1, 45000.00, '2024-02-15', 1),
(5, 2, 45000.00, '2024-03-15', 1),
(5, 3, 45000.00, '2024-04-15', 1),
(5, 4, 45000.00, '2024-05-15', 1),
(5, 5, 45000.00, '2024-06-15', 1),
(5, 6, 45000.00, NULL, 0); -- Не оплачен

-- Создание диаграммы базы данных (это делается через SSMS графически, но вот SQL для создания основных объектов)
PRINT 'База данных создана успешно!';
PRINT 'Для просмотра диаграммы базы данных:';
PRINT '1. Откройте SQL Server Management Studio (SSMS)';
PRINT '2. Подключитесь к вашему серверу';
PRINT '3. Разверните базу данных TradeRentalManagement';
PRINT '4. Щелкните правой кнопкой мыши на "Database Diagrams" и создайте новую диаграмму';
PRINT '5. Добавьте все созданные таблицы в диаграмму';

-- Демонстрационный запрос для проверки связей
SELECT 
    c.Номер_Договора,
    cl.Название as Клиент,
    rp.Адрес as Торговая_Точка,
    d.Название as Скидка,
    c.Финальная_Стоимость,
    COUNT(p.ID) as Количество_Платежей,
    SUM(CASE WHEN p.Статус = 1 THEN p.Сумма ELSE 0 END) as Оплаченная_Сумма
FROM Contract c
    INNER JOIN Client cl ON c.ID_Клиента = cl.ID
    INNER JOIN RetailPoint rp ON c.ID_Точки = rp.ID
    LEFT JOIN Discount d ON c.ID_Скидки = d.ID_Скидки
    LEFT JOIN Payment p ON c.ID = p.ID_Договора
GROUP BY c.Номер_Договора, cl.Название, rp.Адрес, d.Название, c.Финальная_Стоимость
ORDER BY c.Номер_Договора;